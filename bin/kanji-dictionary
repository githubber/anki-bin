#!/usr/bin/env perl
use 5.14.0;
use warnings;
use utf8::all;
use Anki::Database;

my $anki = Anki::Database->new;

say '<?xml version="1.0" encoding="UTF-8"?>
<d:dictionary xmlns="http://www.w3.org/1999/xhtml" xmlns:d="http://www.apple.com/DTDs/DictionaryService-1.0.rng">';

my %sentences_for_kanji;
my @cards;

$anki->each_card(sub {
    my ($card) = @_;
    my $model_name = $card->model->name;

    if ($model_name eq '文') {
        my $sentence = $card->field('日本語');
        for my $kanji ($sentence =~ /\p{Han}/g) {
            push @{ $sentences_for_kanji{ $kanji } }, $sentence;
        }
    }
    elsif ($model_name eq '漢字') {
        push @cards, $card;
    }
});

my $id = 0;
for my $card (@cards) {
    my $kanji     = $card->field('漢字');
    my $english   = $card->field('英語');
    my @sentences = @{ $sentences_for_kanji{ $kanji } || [] };

    ++$id;

    say qq{
        <d:entry id="kanji_$id" d:title="$kanji">
        <d:index d:value="$kanji"/>
        <d:index d:value="$english"/>
        <p><h1>$kanji</h1>$english</p>
        </d:entry>
    };
}

say '</d:dictionary>';

